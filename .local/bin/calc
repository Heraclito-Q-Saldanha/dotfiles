#!/bin/bash

RESULT_FILE="/tmp/bc.history"
if [ ! -f "$RESULT_FILE" ]; then
    > "$RESULT_FILE"
fi

LAST_WOFI=""
BC_RET=""

while :; do
    bc_hist=$(tac "$RESULT_FILE" | head -1000)
    WOFI_RET=$(wofi --sort-order=default --cache-file=/dev/null -d -p calc <<< "$bc_hist")

    rtrn=$?

    if test "$rtrn" = "0"; then
        if [[ "$WOFI_RET" =~ .*=.* ]]; then
            RESULT=$(echo "$WOFI_RET" | awk '{print $NF}')
            wl-copy "$RESULT"
            exit 0
        else
            BC_RET=$(echo "scale=16; $WOFI_RET" | bc -l 2>/dev/null)

            if [ -n "$BC_RET" ]; then
                LAST_WOFI="$WOFI_RET"
                echo "$WOFI_RET = $BC_RET" >> "$RESULT_FILE"
            fi
        fi
    else
        if [ -n "$LAST_WOFI" ]; then
            RESULT=$(echo "scale=16; $LAST_WOFI" | bc -l 2>/dev/null)
            wl-copy "$RESULT"
        fi
        exit 0
    fi
done
